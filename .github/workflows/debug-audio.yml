name: Debug Audio / Bluetooth

on:
  workflow_dispatch: {}

jobs:
  diag:
    runs-on: self-hosted
    steps:
      - name: Contexte systÃ¨me
        run: |
          echo "Hostname: $(hostname)"
          echo "User: $(whoami)"
          echo "Date: $(date)"
          uname -a
          echo "-------------- ENV --------------"
          env | sort || true

      - name: Bluetooth
        run: |
          echo "===== dmesg bluetooth ====="
          dmesg | grep -i bluetooth | tail -n 200 || true
          echo "===== rfkill ====="
          rfkill list || true
          echo "===== systemctl bluetooth ====="
          systemctl status bluetooth --no-pager || true
          echo "===== bluetoothctl devices ====="
          bluetoothctl devices || true
          echo "===== paired devices ====="
          bluetoothctl paired-devices || true

      - name: Audio PipeWire/Pulse (user oryx)
        run: |
          RUNTIME_DIR=/run/user/1000
          echo "XDG_RUNTIME_DIR=$RUNTIME_DIR"
          sudo -u oryx XDG_RUNTIME_DIR=$RUNTIME_DIR systemctl --user status pipewire pipewire-pulse wireplumber --no-pager || true
          sudo -u oryx XDG_RUNTIME_DIR=$RUNTIME_DIR pactl list short cards || true
          sudo -u oryx XDG_RUNTIME_DIR=$RUNTIME_DIR pactl list short sinks || true
          sudo -u oryx XDG_RUNTIME_DIR=$RUNTIME_DIR pactl info || true

      - name: Journal JBL
        run: |
          RUNTIME_DIR=/run/user/1000
          sudo -u oryx XDG_RUNTIME_DIR=$RUNTIME_DIR journalctl --user -u jbl-autoconnect -b --no-pager || true

      - name: Sauvegarde logs
        run: |
          mkdir -p diag
          dmesg | tail -n 500 > diag/dmesg_tail.txt || true
          systemctl status bluetooth --no-pager > diag/status_bluetooth.txt || true
          RUNTIME_DIR=/run/user/1000
          sudo -u oryx XDG_RUNTIME_DIR=$RUNTIME_DIR pactl list short sinks > diag/pactl_sinks.txt || true
          sudo -u oryx XDG_RUNTIME_DIR=$RUNTIME_DIR pactl info > diag/pactl_info.txt || true
          sudo -u oryx XDG_RUNTIME_DIR=$RUNTIME_DIR journalctl --user -u jbl-autoconnect -b --no-pager > diag/jbl_autoconnect.txt || true

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: diag-audio-bluetooth
          path: diag/
