name: Debug Audio / Bluetooth

on:
  workflow_dispatch: {}

jobs:
  diag:
    runs-on: self-hosted
    steps:
      - name: Contexte systÃ¨me
        run: |
          echo "Host: $(hostname)"
          echo "User: $(whoami)"
          echo "Kernel: $(uname -a)"
          echo "Date: $(date)"
          echo "---------------- ENV ----------------"
          env | sort || true

      - name: Bluetooth
        run: |
          echo "===== dmesg bluetooth ====="
          dmesg | grep -i bluetooth | tail -n 100 || true
          echo "===== rfkill ====="
          rfkill list || true
          echo "===== systemctl bluetooth ====="
          systemctl status bluetooth --no-pager || true
          echo "===== bluetoothctl paired-devices ====="
          bluetoothctl paired-devices || true
          echo "===== bluetoothctl info JBL ====="
          bluetoothctl info 40:C1:F6:70:C0:1A || true

      - name: Audio PipeWire/Pulse (user oryx)
        run: |
          RDIR="/run/user/1000"
          echo "XDG_RUNTIME_DIR=$RDIR"
          sudo -u oryx XDG_RUNTIME_DIR=$RDIR systemctl --user status pipewire pipewire-pulse wireplumber --no-pager || true
          sudo -u oryx XDG_RUNTIME_DIR=$RDIR pactl list short cards || true
          sudo -u oryx XDG_RUNTIME_DIR=$RDIR pactl list short sinks || true
          sudo -u oryx XDG_RUNTIME_DIR=$RDIR pactl info || true

      - name: Journal JBL
        run: |
          RDIR="/run/user/1000"
          sudo -u oryx XDG_RUNTIME_DIR=$RDIR journalctl --user -u jbl-autoconnect -b --no-pager || true

      - name: Collecte des logs
        run: |
          mkdir -p diag
          dmesg | tail -n 300 > diag/dmesg.txt || true
          systemctl status bluetooth --no-pager > diag/bluetooth_status.txt || true
          sudo -u oryx XDG_RUNTIME_DIR=/run/user/1000 pactl list short sinks > diag/pactl_sinks.txt || true
          sudo -u oryx XDG_RUNTIME_DIR=/run/user/1000 pactl info > diag/pactl_info.txt || true
          sudo -u oryx XDG_RUNTIME_DIR=/run/user/1000 journalctl --user -u jbl-autoconnect -b --no-pager > diag/jbl_service.txt || true

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: debug-audio-bluetooth
          path: diag/
